#!/usr/bin/env python3
"""
測試配置檔案
設定 pytest 和測試環境
"""

import pytest
import os
import sys
from pathlib import Path

# 添加專案根目錄到 Python 路徑
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# 測試配置
pytest_plugins = []

def pytest_configure(config):
    """pytest 配置"""
    # 設定測試環境變數
    os.environ['FLASK_ENV'] = 'testing'
    os.environ['DATABASE_URL'] = 'sqlite:///:memory:'
    os.environ['SECRET_KEY'] = 'test-secret-key'
    os.environ['CHROMA_PERSIST_DIRECTORY'] = './test_chroma_db'

def pytest_collection_modifyitems(config, items):
    """修改測試收集"""
    # 標記慢速測試
    for item in items:
        if "slow" in item.keywords:
            item.add_marker(pytest.mark.slow)
        
        # 標記整合測試
        if "integration" in item.name:
            item.add_marker(pytest.mark.integration)

# 測試標記
def pytest_configure(config):
    config.addinivalue_line(
        "markers", "slow: marks tests as slow (deselect with '-m \"not slow\"')"
    )
    config.addinivalue_line(
        "markers", "integration: marks tests as integration tests"
    )
    config.addinivalue_line(
        "markers", "unit: marks tests as unit tests"
    )

# 測試覆蓋率配置
def pytest_cov_configure(config):
    """覆蓋率配置"""
    config.option.cov_report = ['term-missing', 'html']
    config.option.cov_fail_under = 70
